#!/bin/bash
# Copyright (c) 2015-2016:
#   Matthieu Estrada, ttamalfor@gmail.com
#
# This file is part of (AlignakApp).
#
# (AlignakApp) is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# (AlignakApp) is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with (AlignakApp).  If not, see <http://www.gnu.org/licenses/>.

APP_ROOT=$HOME/.local/alignak_app
USER_BIN=$HOME/bin
APP_NAME=alignakapp
APP_SCRIPT=launch

if [ -d "$APP_ROOT" ]; then

    #Â Verify installation
    echo "Alignak-app verify installation..."
    if [ ! -L "$USER_BIN/$APP_NAME" ]; then
        echo "The command is not yet created..."
        echo "Prepare folder..."
        if [ ! -d "$USER_BIN" ]; then
            mkdir $USER_BIN
        fi
        if [ -f "$APP_ROOT/$APP_SCRIPT" ]; then
            echo "Create command for alignakapp..."
            ln -s "$APP_ROOT/$APP_SCRIPT" "$USER_BIN/$APP_NAME"
        else
            echo "ERROR: file [$APP_SCRIPT] is missing !"
            exit 1
        fi
    fi
    if [[ :$PATH: == *:"$USER_BIN":* ]] ; then
	echo "Path already added."
        source ~/.profile
    else
        echo "Adding to path..."
        PATH="$PATH:$USER_BIN"
        source ~/.profile
    fi
    echo -e "
        #####################################################
        #      Now, command [alignakapp] is available.      #
        #####################################################
           "
    echo "Installation is ok !"

    # Check if Application is not running.
    CHECK=`ps fu |grep "alignak_app.app"|grep -v "grep"|awk '{print $2}'`

    if [ ! -z "$CHECK" -a "$CHECK" != " " ] ; then
        echo "A process of Alignak-app already running..."
        echo "-> kill process (with PID : $CHECK)..."
        kill "$CHECK"
        echo "
    #####################################################
    #               Alignak-app restart !               #
    #####################################################
            "
    else
        echo "
    #####################################################
    #               Alignak-app start !               #
    #####################################################
            "
    fi

    python3 -c \
        """
import os
import sys

from logging import getLogger
from alignak_app.app import AlignakApp


logger = getLogger(__name__)

try:
    os.environ['DESKTOP_SESSION']
except KeyError as e:
    logger.critical('You must be in desktop session to launch Alignak-App : ' + str(e))
    sys.exit()

AlignakApp().run()
        """ &

else
    echo -e "
    ERROR: installation seems broken !
    Folder [$APP_ROOT] does not exist !
           "
fi
